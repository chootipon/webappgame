import { useEffect, useState, useRef } from "react";
import { Sun, Moon, RefreshCw, ArrowRightCircle, CheckCircle, XCircle, Image as ImageIcon } from "lucide-react";

export default function PpeGame() {
  const TOTAL_QUESTIONS = 10;
  const [questions, setQuestions] = useState([]);
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [questionIndex, setQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [askedIds, setAskedIds] = useState(new Set());
  const [showExplanation, setShowExplanation] = useState(false);
  const [selectedChoice, setSelectedChoice] = useState(null);
  const [isFinished, setIsFinished] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [highScore, setHighScore] = useState(
    typeof window !== "undefined" ? localStorage.getItem("ppeHighScore") || 0 : 0
  );
  const correctSoundRef = useRef(null);
  const wrongSoundRef = useRef(null);

  useEffect(() => {
    fetch(
      "https://script.google.com/macros/s/AKfycbzCpJJNVOdsRVUtHAZjRbC59gvavFDDf8mQod2U5Mn2K_512W_p7Zzndn1y8GqB2LU0/exec"
    )
      .then((res) => res.json())
      .then((data) => setQuestions(data))
      .catch((err) => console.error("Error loading questions", err));
  }, []);

  useEffect(() => {
    if (questions.length && questionIndex < TOTAL_QUESTIONS) {
      let q;
      do {
        q = questions[Math.floor(Math.random() * questions.length)];
      } while (askedIds.has(q.id));

      setAskedIds(new Set([...askedIds, q.id]));
      setCurrentQuestion(q);
    }
  }, [questions, questionIndex]);

  const handleChoice = (choice) => {
    if (!currentQuestion || selectedChoice) return;
    setSelectedChoice(choice);
    setShowExplanation(true);
    const isCorrect = choice === currentQuestion.correctAnswer.toUpperCase();
    if (isCorrect) {
      correctSoundRef.current?.play();
      setScore((prev) => prev + 1);
    } else {
      wrongSoundRef.current?.play();
    }
  };

  const nextQuestion = () => {
    setShowExplanation(false);
    setSelectedChoice(null);
    if (questionIndex + 1 >= TOTAL_QUESTIONS) {
      setIsFinished(true);
      const prevHigh = parseInt(highScore);
      if (score > prevHigh) {
        localStorage.setItem("ppeHighScore", score);
        setHighScore(score);
      }
    } else {
      setQuestionIndex((prev) => prev + 1);
    }
  };

  const restart = () => {
    setScore(0);
    setAskedIds(new Set());
    setQuestionIndex(0);
    setShowExplanation(false);
    setSelectedChoice(null);
    setIsFinished(false);
  };

  return (
    <div className={`min-h-screen flex flex-col items-center justify-start px-4 py-6 transition-colors duration-300 ${darkMode ? 'bg-gray-900 text-white' : 'bg-gradient-to-br from-green-200 to-blue-100 text-gray-800'}`}>
      <audio ref={correctSoundRef} src="/sounds/correct.mp3" preload="auto" />
      <audio ref={wrongSoundRef} src="/sounds/wrong.mp3" preload="auto" />

      <div className="flex justify-between w-full max-w-md items-center mb-4">
        <h1 className="text-3xl md:text-4xl font-bold drop-shadow text-green-800 dark:text-green-400">
          เกมอบรม PPE โรงงาน
        </h1>
        <button
          onClick={() => setDarkMode(!darkMode)}
          className="p-2 rounded-full shadow bg-white dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition"
        >
          {darkMode ? <Sun className="w-5 h-5 text-yellow-400" /> : <Moon className="w-5 h-5 text-gray-700" />}
        </button>
      </div>

      <div className="text-xl font-semibold mb-2 text-green-700 dark:text-green-300">
        คะแนนรวม: {score}
      </div>
      <div className="text-lg font-medium mb-4 text-green-600 dark:text-green-200">
        คำถามที่ {questionIndex + 1} จาก {TOTAL_QUESTIONS}
      </div>

      <div className="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 w-full max-w-md transition-all">
        {isFinished ? (
          <>
            <p className="text-xl font-semibold text-center mb-3">
              จบเกม! คะแนนของคุณคือ {score} / {TOTAL_QUESTIONS}
            </p>
            <p className="text-center text-green-600 dark:text-green-300 mb-4">
              คะแนนสูงสุด: {highScore}
            </p>
            <button
              onClick={restart}
              className="w-full flex justify-center items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition shadow-md"
            >
              <RefreshCw className="w-5 h-5" /> เล่นอีกครั้ง
            </button>
          </>
        ) : !currentQuestion ? (
          <p className="text-center py-10 text-gray-500 dark:text-gray-400 animate-pulse">กำลังโหลดคำถาม...</p>
        ) : (
          <>
            {currentQuestion.image && (
              <img src={currentQuestion.image} alt="PPE Question" className="mb-4 rounded-xl w-full h-auto object-contain border dark:border-gray-700" />
            )}
            <p className="text-lg font-bold mb-4">
              [{currentQuestion.situation}] {currentQuestion.question}
            </p>
            {['A', 'B', 'C'].map((ch) => {
              const txt = currentQuestion[`choice${ch}`];
              const isCorrect = ch === currentQuestion.correctAnswer.toUpperCase();
              return (
                <button
                  key={ch}
                  onClick={() => handleChoice(ch)}
                  disabled={!!selectedChoice}
                  className={`w-full text-left px-4 py-3 rounded-xl mb-3 font-medium border transition shadow-md
                    ${selectedChoice === ch
                    ? isCorrect
                      ? 'bg-green-500 text-white border-green-600'
                      : 'bg-red-400 text-white border-red-500'
                    : 'bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-700 text-gray-800 dark:text-white border-blue-300 dark:border-blue-700'}
                  `}
                >
                  {ch}. {txt}
                </button>
              );
            })}
            {showExplanation && (
              <div className="mt-4 text-sm border-t pt-3">
                <strong className="flex items-center gap-2">
                  {selectedChoice === currentQuestion.correctAnswer.toUpperCase()
                    ? <><CheckCircle className="w-4 h-4 text-green-600" /> ถูกต้อง:</>
                    : <><XCircle className="w-4 h-4 text-red-500" /> ผิด:</>
                  }
                </strong>{" "}
                {currentQuestion.explanation}
              </div>
            )}
            {selectedChoice && (
              <button
                onClick={nextQuestion}
                className="w-full mt-6 flex justify-center items-center gap-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 rounded-xl shadow-md transition"
              >
                <ArrowRightCircle className="w-5 h-5" /> คำถามถัดไป
              </button>
            )}
          </>
        )}
      </div>
    </div>
  );
}
