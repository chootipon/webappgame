<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PPE Training Game</title>
  <style>
    /* (‡∏ï‡∏±‡∏î style ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) */
  </style>
</head>
<body>
  <h1>‡πÄ‡∏Å‡∏°‡∏≠‡∏ö‡∏£‡∏° PPE ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</h1>
  <div id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: 0</div>
  <div id="progress">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 0 ‡∏à‡∏≤‡∏Å 10</div>
  <div id="questionBox">
    <div class="questionText" id="questionText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°...</div>
    <button class="choiceBtn" id="btnA"></button>
    <button class="choiceBtn" id="btnB"></button>
    <button class="choiceBtn" id="btnC"></button>
    <div id="explanation"></div>
    <button id="nextBtn">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
  </div>

  <script>
    const TOTAL_QUESTIONS = 10;
    let currentQuestion = null;
    let score = 0;
    let questionIndex = 0;
    let askedQuestions = new Set();
    let questions = [];
    let questionsLoaded = false;

    const questionText = document.getElementById('questionText');
    const btnA = document.getElementById('btnA');
    const btnB = document.getElementById('btnB');
    const btnC = document.getElementById('btnC');
    const explanation = document.getElementById('explanation');
    const scoreDiv = document.getElementById('score');
    const progressDiv = document.getElementById('progress');
    const nextBtn = document.getElementById('nextBtn');

    function resetButtons() {
      [btnA, btnB, btnC].forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('correct');
        btn.classList.remove('ripple');
        btn.style.backgroundColor = '#6c63ff';
        btn.style.boxShadow = '0 6px 12px rgba(108, 99, 255, 0.5)';
        btn.style.color = '#fff';
      });
    }

    function highlightCorrectAnswer() {
      const correct = currentQuestion.correctAnswer.toUpperCase();
      if (correct === 'A') btnA.classList.add('correct');
      else if (correct === 'B') btnB.classList.add('correct');
      else if (correct === 'C') btnC.classList.add('correct');
    }

    function updateProgress() {
      progressDiv.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${questionIndex} ‡∏à‡∏≤‡∏Å ${TOTAL_QUESTIONS}`;
    }

    function checkAnswer(choice) {
      [btnA, btnB, btnC].forEach(btn => btn.disabled = true);

      // Ripple effect
      [btnA, btnB, btnC].forEach(btn => btn.classList.remove('ripple'));
      const clickedBtn = choice === 'A' ? btnA : choice === 'B' ? btnB : btnC;
      clickedBtn.classList.add('ripple');
      setTimeout(() => clickedBtn.classList.remove('ripple'), 600);

      const isCorrect = choice === currentQuestion.correctAnswer.toUpperCase();
      if (isCorrect) {
        score++;
        scoreDiv.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${score}`;
      }

      explanation.textContent = (isCorrect ? '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ' : '‡∏ú‡∏¥‡∏î! ') + currentQuestion.explanation;
      explanation.classList.add('show');

      highlightCorrectAnswer();
      nextBtn.style.display = 'inline-block';
    }

    function showFinalScore() {
      questionText.textContent = `‡∏à‡∏ö‡πÄ‡∏Å‡∏°! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${score} ‡∏à‡∏≤‡∏Å ${TOTAL_QUESTIONS}`;
      [btnA, btnB, btnC].forEach(btn => {
        btn.style.display = 'none';
      });
      explanation.classList.remove('show');
      explanation.textContent = '';

      nextBtn.textContent = '‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      nextBtn.style.display = 'inline-block';

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å high score ‡πÉ‡∏ô localStorage
      const highScore = localStorage.getItem('ppeHighScore') || 0;
      if (score > highScore) {
        localStorage.setItem('ppeHighScore', score);
        explanation.textContent = 'üéâ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà! üéâ';
      } else {
        explanation.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${highScore}`;
      }
      explanation.classList.add('show');

      nextBtn.onclick = () => {
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°
        score = 0;
        scoreDiv.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${score}`;
        questionIndex = 0;
        askedQuestions.clear();
        [btnA, btnB, btnC].forEach(btn => {
          btn.style.display = 'block';
        });
        nextBtn.textContent = '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        nextBtn.style.display = 'none';
        explanation.classList.remove('show');
        explanation.textContent = '';
        nextBtn.onclick = () => loadQuestion();
        loadQuestion();
      };
    }

    function loadQuestion() {
      explanation.classList.remove('show');
      explanation.textContent = '';
      nextBtn.style.display = 'none';

      if (!questionsLoaded) {
        fetch('https://script.google.com/macros/s/AKfycbzCpJJNVOdsRVUtHAZjRbC59gvavFDDf8mQod2U5Mn2K_512W_p7Zzndn1y8GqB2LU0/exec')
          .then(res => res.json())
          .then(data => {
            questions = data;
            questionsLoaded = true;
            loadQuestion();
          })
          .catch(err => {
            questionText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            console.error(err);
          });
        return;
      }

      if (questionIndex >= TOTAL_QUESTIONS) {
        showFinalScore();
        return;
      }

      resetButtons();

      let question;
      do {
        const randomIndex = Math.floor(Math.random() * questions.length);
        question = questions[randomIndex];
      } while (askedQuestions.has(question.id));

      askedQuestions.add(question.id);
      currentQuestion = question;
      questionIndex++;
      updateProgress();

      questionText.textContent = `[${question.situation}] ${question.question}`;
      btnA.textContent = 'A. ' + question.choiceA;
      btnB.textContent = 'B. ' + question.choiceB;
      btnC.textContent = 'C. ' + question.choiceC;
    }

    btnA.onclick = () => checkAnswer('A');
    btnB.onclick = () => checkAnswer('B');
    btnC.onclick = () => checkAnswer('C');
    nextBtn.onclick = () => loadQuestion();

    window.onload = loadQuestion;
  </script>
</body>
</html>
